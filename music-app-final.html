<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üéπ Kids Keyboard Lab ‚Äì 30-Hour Music Mastery</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --accent: #22c55e;
      --accent-soft: #bbf7d0;
      --text: #f9fafb;
      --muted: #9ca3af;
      --danger: #f87171;
      --warn: #facc15;
      --teach: #3b82f6;
      --teach-bg: #dbeafe;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #1e293b, #020617);
      color: var(--text);
      min-height: 100vh;
      padding: 16px;
    }

    .app {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .title {
      font-size: 1.3rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge {
      font-size: 0.7rem;
      padding: 4px 8px;
      border-radius: 12px;
      background: rgba(34, 197, 94, 0.15);
      color: var(--accent-soft);
      border: 1px solid rgba(34, 197, 94, 0.6);
    }

    .tabs {
      display: flex;
      gap: 6px;
    }

    .tab {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.8rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.8);
      color: var(--muted);
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab.active {
      background: linear-gradient(135deg, #22c55e, #4ade80);
      color: #022c22;
      border-color: transparent;
      font-weight: 600;
    }

    .layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    @media (max-width: 1024px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.95), rgba(2, 6, 23, 0.98));
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    .card h2 {
      font-size: 0.95rem;
      margin: 0 0 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card h3 {
      font-size: 0.85rem;
      margin: 6px 0 4px;
    }

    .small {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .level-list {
      max-height: 500px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .level-item {
      padding: 8px;
      border-radius: 10px;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }

    .level-item:hover {
      background: rgba(30, 64, 175, 0.25);
      transform: translateX(2px);
    }

    .level-item.active {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.4));
      border: 1px solid rgba(34, 197, 94, 0.65);
    }

    .level-title {
      font-size: 0.8rem;
      font-weight: 600;
    }

    .level-tag {
      font-size: 0.7rem;
      color: var(--muted);
    }

    .pill {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.65rem;
      border: 1px solid rgba(148, 163, 184, 0.5);
      white-space: nowrap;
    }

    .pill.green {
      border-color: rgba(34, 197, 94, 0.8);
      color: var(--accent-soft);
    }

    .pill.blue {
      border-color: rgba(59, 130, 246, 0.8);
      color: #bfdbfe;
    }

    .main-content {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .teach-box {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(30, 144, 255, 0.05));
      border: 1px solid rgba(59, 130, 246, 0.5);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 8px;
    }

    .teach-box h4 {
      font-size: 0.8rem;
      color: #93c5fd;
      margin: 0 0 6px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .teach-box p {
      font-size: 0.8rem;
      line-height: 1.5;
      margin: 0;
      color: #e0e7ff;
    }

    .teach-box ul {
      margin: 6px 0 0;
      padding-left: 18px;
      font-size: 0.8rem;
      color: #e0e7ff;
    }

    .teach-box li {
      margin-bottom: 3px;
    }

    .staff-area {
      background: linear-gradient(135deg, rgba(30, 58, 138, 0.1), rgba(12, 74, 110, 0.08));
      border-radius: 12px;
      padding: 16px;
      border: 1px solid rgba(59, 130, 246, 0.3);
      margin-bottom: 12px;
    }

    .staff {
      position: relative;
      height: 160px;
      background: linear-gradient(to bottom, rgba(15, 23, 42, 0.95), rgba(2, 6, 23, 0.98));
      border: 1px solid rgba(148, 163, 184, 0.3);
      border-radius: 10px;
      overflow: visible;
      margin-bottom: 8px;
    }

    .staff-note {
      position: absolute;
      width: 22px;
      height: 14px;
      border-radius: 999px;
      background: #e5e7eb;
      border: 2px solid #020617;
      box-shadow: 0 0 12px rgba(248, 250, 252, 0.9);
      transition: all 0.25s ease-out;
      z-index: 10;
    }

    .staff-note::after {
      content: "";
      position: absolute;
      width: 1.5px;
      height: 32px;
      background: #e5e7eb;
      right: -3px;
      top: -30px;
    }

    .staff-line {
      position: absolute;
      height: 1px;
      background: rgba(148, 163, 184, 0.85);
      width: 100%;
    }

    .ledger-line {
      position: absolute;
      height: 1px;
      background: rgba(148, 163, 184, 0.75);
      width: 50px;
      left: 50%;
      transform: translateX(-50%);
    }

    .prompt {
      font-size: 0.85rem;
      margin: 8px 0;
      color: var(--muted);
      font-weight: 500;
    }

    .flashcard-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 8px;
      align-items: center;
    }

    .flashcard-btn {
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      font-size: 0.8rem;
      cursor: pointer;
      color: var(--muted);
      font-weight: 600;
      transition: all 0.15s;
    }

    .flashcard-btn:hover {
      background: rgba(59, 130, 246, 0.15);
      border-color: rgba(59, 130, 246, 0.7);
    }

    .flashcard-btn.correct {
      background: rgba(22, 163, 74, 0.2);
      color: #bbf7d0;
      border-color: rgba(22, 163, 74, 0.9);
    }

    .flashcard-btn.wrong {
      background: rgba(239, 68, 68, 0.15);
      color: #fecaca;
      border-color: rgba(239, 68, 68, 0.9);
    }

    .keyboard {
      position: relative;
      display: flex;
      height: 100px;
      margin-top: 8px;
    }

    .white-keys {
      display: flex;
      flex: 1;
      background: #0b1120;
      padding: 6px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      gap: 2px;
    }

    .white-key {
      flex: 1;
      background: linear-gradient(to bottom, #f9fafb, #d1d5db);
      border-radius: 0 0 6px 6px;
      border: 1px solid #9ca3af;
      position: relative;
      cursor: pointer;
      box-shadow: inset 0 -3px 5px rgba(148, 163, 184, 0.9);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      font-size: 0.7rem;
      color: #374151;
      font-weight: 600;
      transition: all 0.1s;
    }

    .white-key:hover {
      box-shadow: inset 0 -2px 4px rgba(148, 163, 184, 0.8), 0 0 8px rgba(34, 197, 94, 0.3);
    }

    .white-key.active {
      background: linear-gradient(to bottom, #bbf7d0, #6ee7b7);
      transform: translateY(2px);
      box-shadow: inset 0 -1px 2px rgba(55, 65, 81, 0.8), 0 0 12px rgba(34, 197, 94, 0.6);
    }

    .white-key span {
      margin-bottom: 6px;
      opacity: 0.9;
    }

    .btn-group {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin: 8px 0;
    }

    .btn {
      border-radius: 999px;
      border: none;
      font-size: 0.75rem;
      padding: 6px 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #4ade80);
      color: #022c22;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--muted);
    }

    .btn-ghost:hover {
      background: rgba(59, 130, 246, 0.15);
      border-color: rgba(59, 130, 246, 0.8);
    }

    .btn-audio {
      background: linear-gradient(135deg, #3b82f6, #60a5fa);
      color: white;
    }

    .btn-audio:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 8px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .status-pill {
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(31, 41, 55, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.6);
    }

    .score-display {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--accent-soft);
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .exam-section {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.08), rgba(217, 119, 6, 0.05));
      border: 1px solid rgba(245, 158, 11, 0.4);
      border-radius: 12px;
      padding: 12px;
      margin-top: 12px;
    }

    .exam-section h3 {
      color: #fcd34d;
      margin: 0 0 6px;
    }

    .summary-text {
      font-size: 0.8rem;
      line-height: 1.5;
      color: var(--muted);
    }

    .metric {
      display: inline-block;
      margin-right: 12px;
      font-size: 0.75rem;
    }

    .metric-value {
      font-weight: 700;
      color: var(--accent-soft);
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        üéπ Kids Keyboard Lab
        <span class="badge">30-Hour Beginner Path</span>
      </div>
      <div class="tabs">
        <button class="tab active" data-tab="learn">üéì Learn</button>
        <button class="tab" data-tab="practice">üéØ Practice</button>
        <button class="tab" data-tab="exam">üìù Exam</button>
      </div>
    </header>

    <div class="layout">
      <!-- LEFT: Curriculum -->
      <aside class="card">
        <h2>
          üìö Levels
          <span class="small" id="total-hours">0/30 hrs</span>
        </h2>
        <p class="small">Tap a level to start. Levels teach ‚Üí practice ‚Üí test progression.</p>
        <div class="level-list" id="level-list"></div>
      </aside>

      <!-- RIGHT: Main interaction -->
      <section class="main-content">
        <!-- Teaching box -->
        <div class="teach-box" id="teach-box">
          <h4>üìñ Today's Lesson</h4>
          <p id="teach-content">Welcome! Start by selecting a level.</p>
        </div>

        <!-- Main interaction card -->
        <div class="card">
          <div style="margin-bottom: 8px;">
            <h2 id="panel-title">Level 1: Meet the Staff & Notes E‚ÄìG</h2>
            <div class="small" id="panel-subtitle">Learn the basics of treble clef staff.</div>
          </div>

          <!-- Staff area -->
          <div class="staff-area">
            <div class="staff" id="staff"></div>
            <div class="prompt" id="prompt-text">Select a level to begin.</div>
          </div>

          <!-- Flashcard options -->
          <div class="flashcard-row" id="flashcard-row" style="display: none;">
            <span style="font-size: 0.8rem; font-weight: 600;">What note is this?</span>
            <div id="flashcard-options"></div>
          </div>

          <!-- Play note button (for ear training) -->
          <div id="audio-controls" style="display: none;">
            <button class="btn btn-audio" id="play-note-btn">üîä Play Note</button>
            <span class="small" style="color: #93c5fd;">Listen carefully, then identify the note above.</span>
          </div>

          <!-- Virtual keyboard -->
          <div class="keyboard" id="keyboard">
            <div class="white-keys" id="white-keys"></div>
          </div>

          <!-- Status & controls -->
          <div class="status-bar">
            <div class="row">
              <span class="metric">Streak: <span class="metric-value" id="streak">0</span></span>
              <span class="metric">Correct: <span class="metric-value" id="accuracy">0%</span></span>
              <span class="metric">Mode: <span class="metric-value" id="mode-label">Learn</span></span>
            </div>
            <div class="row">
              <button class="btn btn-ghost" id="next-btn" style="display: none;">Next ‚Üí</button>
              <button class="btn btn-primary" id="start-practice-btn">Start Practice</button>
            </div>
          </div>
        </div>

        <!-- Exam panel -->
        <div class="card" id="exam-panel">
          <h2>üìù Exam Center</h2>
          <p class="small">Unlocked after Level 13 or 20+ hours of practice.</p>
          <div class="btn-group">
            <button class="btn btn-primary" id="start-theory-exam">Theory Exam</button>
            <button class="btn btn-primary" id="start-performance-exam">Performance Exam</button>
            <button class="btn btn-ghost" id="end-exam-btn" style="display: none;">End Exam</button>
          </div>
          <div class="summary-text" id="exam-summary">
            No exam active. Complete 20+ practice questions to unlock exams.
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ============== CONFIG: CURRICULUM & NOTES ===============

    const LEVELS = [
      {
        id: 1,
        title: "Meet the Staff & Notes E‚ÄìG",
        tag: "Treble clef basics",
        type: "teach",
        hours: 2,
        notes: ["E4", "G4"],
        teach: `
          <p><strong>Welcome!</strong> Let's learn the treble clef staff.</p>
          <ul>
            <li>The treble staff has <strong>5 lines</strong> and <strong>4 spaces</strong>.</li>
            <li>The bottom line is note <strong>E</strong> (above middle C).</li>
            <li>Notes go up: E, F, G, A, B, C, D, E, F (the alphabet repeats!).</li>
            <li>We start with notes <strong>E</strong> (on the bottom line) and <strong>G</strong> (on the second line).</li>
          </ul>
        `
      },
      {
        id: 2,
        title: "Add Note B (the middle line)",
        tag: "Lines only",
        type: "teach",
        hours: 2,
        notes: ["E4", "G4", "B4"],
        teach: `
          <p><strong>Great!</strong> Now meet <strong>B</strong>.</p>
          <ul>
            <li>Every Good Boy Does Fine <strong>(E‚ÄìG‚ÄìB‚ÄìD‚ÄìF)</strong> ‚Äì the 5 lines!</li>
            <li><strong>B</strong> is on the <strong>middle line</strong> of the staff.</li>
            <li>Practice seeing E, G, B on the staff before touching the keyboard.</li>
          </ul>
        `
      },
      {
        id: 3,
        title: "Space notes: F & A",
        tag: "Spaces only",
        type: "teach",
        hours: 2,
        notes: ["F4", "A4"],
        teach: `
          <p><strong>New pattern!</strong> Let's learn spaces.</p>
          <ul>
            <li>Notes in spaces spell <strong>FACE</strong> (bottom space ‚Üí top space).</li>
            <li>F is in the <strong>first space</strong> (between E and G lines).</li>
            <li>A is in the <strong>second space</strong> (between G and B lines).</li>
            <li>No line through the note = it's in a space!</li>
          </ul>
        `
      },
      {
        id: 4,
        title: "All notes C‚ÄìG: play on keyboard",
        tag: "Keyboard connection",
        type: "play",
        hours: 2,
        notes: ["C4", "D4", "E4", "F4", "G4"],
        teach: `
          <p><strong>Ready to play!</strong> Let's connect staff to keyboard.</p>
          <ul>
            <li>C is on a <strong>ledger line below</strong> the staff (below E).</li>
            <li>D is in the space between C and E.</li>
            <li>Tap a virtual key to match the note shown on the staff.</li>
            <li>Try to be <strong>accurate and fast!</strong></li>
          </ul>
        `
      },
      {
        id: 5,
        title: "Add A & B: full C‚ÄìB range",
        tag: "Extended range",
        type: "play",
        hours: 2,
        notes: ["C4", "D4", "E4", "F4", "G4", "A4", "B4"],
        teach: `
          <p><strong>Expand your range!</strong> Now C to B.</p>
          <ul>
            <li>You've learned all the notes from C to B!</li>
            <li>Lines: <strong>E, G, B, D, F</strong> (Every Good Boy Does Fine).</li>
            <li>Spaces: <strong>F, A, C, E</strong> (FACE).</li>
            <li>Extra: <strong>C</strong> on ledger line below the staff, and <strong>D</strong> in the lower space.</li>
          </ul>
        `
      },
      {
        id: 6,
        title: "Ear Training Level 1: Listen & identify",
        tag: "Sound recognition",
        type: "ear",
        hours: 2,
        notes: ["C4", "D4", "E4", "F4", "G4"],
        teach: `
          <p><strong>New skill: Ears!</strong> Listen to a note and identify it.</p>
          <ul>
            <li>Click <strong>"Play Note"</strong> to hear a note.</li>
            <li>The note appears on the staff.</li>
            <li>Can you identify it by letter or by position?</li>
            <li>This trains your musical ear!</li>
          </ul>
        `
      },
      {
        id: 7,
        title: "Rhythm: Quarter & half notes",
        tag: "Timing basics",
        type: "teach",
        hours: 2,
        notes: ["E4", "G4", "B4", "D5", "F5"],
        teach: `
          <p><strong>Add rhythm!</strong> Let's learn note duration.</p>
          <ul>
            <li><strong>Quarter note</strong> (‚ô©): 1 beat. <strong>Half note</strong> (ùÖóùÖ•): 2 beats.</li>
            <li>In 4/4 time: quarter + quarter + half = one measure.</li>
            <li>We'll use a metronome in practice to keep steady time.</li>
          </ul>
        `
      },
      {
        id: 8,
        title: "Whole notes & rests",
        tag: "Duration extended",
        type: "teach",
        hours: 2,
        notes: ["C4", "G4"],
        teach: `
          <p><strong>Complete durations!</strong> Whole notes and silence.</p>
          <ul>
            <li><strong>Whole note</strong> (ùÖù): 4 beats (one full measure in 4/4).</li>
            <li><strong>Rest</strong> (ùÑΩ): silence for the same duration.</li>
            <li>Practice: Hold C for 4 counts, then wait 4 counts (rest).</li>
          </ul>
        `
      },
      {
        id: 9,
        title: "Ear Training Level 2: Extended notes",
        tag: "Advanced listening",
        type: "ear",
        hours: 2,
        notes: ["C4", "D4", "E4", "F4", "G4", "A4", "B4"],
        teach: `
          <p><strong>Challenge yourself!</strong> Listen to the full range C‚ÄìB.</p>
          <ul>
            <li>More notes = more listening skill needed.</li>
            <li>Try to recognize high vs. low notes.</li>
            <li>See if you can hum the note after hearing it!</li>
          </ul>
        `
      },
      {
        id: 10,
        title: "First song: Simple melody",
        tag: "Performance",
        type: "play",
        hours: 2,
        notes: ["C4", "D4", "E4", "F4", "G4"],
        teach: `
          <p><strong>Let's play a song!</strong> Simple 8-bar melody.</p>
          <ul>
            <li>Try to play: C‚ÄìC‚ÄìG‚ÄìA‚ÄìG‚ÄìE‚ÄìD‚ÄìC (a classic beginner tune!).</li>
            <li>Go slowly at first, then speed up.</li>
            <li>Use the metronome in practice mode.</li>
          </ul>
        `
      },
      {
        id: 11,
        title: "Legato & Staccato (style)",
        tag: "Expression",
        type: "teach",
        hours: 2,
        notes: ["E4", "G4", "B4"],
        teach: `
          <p><strong>Add expression!</strong> How we play matters.</p>
          <ul>
            <li><strong>Legato (‚Äì)</strong>: smooth, connected notes. Hold each key.</li>
            <li><strong>Staccato (‚Ä¢)</strong>: short, bouncy notes. Tap and release quickly.</li>
            <li>Try both on the same melody to hear the difference!</li>
          </ul>
        `
      },
      {
        id: 12,
        title: "Sight reading drill",
        tag: "Fluency challenge",
        type: "play",
        hours: 2,
        notes: ["C4", "D4", "E4", "F4", "G4", "A4", "B4"],
        teach: `
          <p><strong>Speed test!</strong> See the note, play it fast.</p>
          <ul>
            <li>Random notes appear on the staff.</li>
            <li>Play them as quickly and accurately as you can.</li>
            <li>Track your speed (notes per minute).</li>
          </ul>
        `
      },
      {
        id: 13,
        title: "Ear Training Level 3: Full range + intervals",
        tag: "Expert listening",
        type: "ear",
        hours: 2,
        notes: ["C4", "D4", "E4", "F4", "G4", "A4", "B4"],
        teach: `
          <p><strong>Final ear test!</strong> Listen like a pro.</p>
          <ul>
            <li>Hear a note in the full C‚ÄìB range.</li>
            <li>Harder: Hear two notes. Are they stepping up or skipping?</li>
            <li>Earn points for fast, accurate identification!</li>
          </ul>
        `
      },
      {
        id: 14,
        title: "Mock Theory Exam",
        tag: "Test prep",
        type: "play",
        hours: 2,
        notes: ["C4", "D4", "E4", "F4", "G4", "A4", "B4"],
        teach: `
          <p><strong>Practice exam!</strong> Just like the real thing.</p>
          <ul>
            <li>Answer 20 flashcard questions (name the note).</li>
            <li>60% = pass, 80% = merit, 90% = distinction.</li>
            <li>See your score and weak areas to review.</li>
          </ul>
        `
      },
      {
        id: 15,
        title: "Final review & exam ready",
        tag: "Mastery",
        type: "play",
        hours: 2,
        notes: ["C4", "D4", "E4", "F4", "G4", "A4", "B4"],
        teach: `
          <p><strong>You're ready!</strong> Final consolidation before the exam.</p>
          <ul>
            <li>Review all skills: note names, keyboard, rhythm, ear training.</li>
            <li>Play some of your favorite songs from the course.</li>
            <li>Then take the final exam in the Exam tab!</li>
          </ul>
        `
      }
    ];

    const TOTAL_HOURS = LEVELS.reduce((sum, l) => sum + l.hours, 0);

    // MIDI note mapping
    const NOTE_TO_MIDI = {
      "C4": 60, "D4": 62, "E4": 64, "F4": 65, "G4": 67, "A4": 69, "B4": 71, "C5": 72,
      "A3": 57, "B3": 59
    };

    const WHITE_NOTES = ["C4", "D4", "E4", "F4", "G4", "A4", "B4"];

    // Staff step mapping (E4 line = step 0)
    const STEP_INDEX = {
      "A3": -4, "B3": -3, "C4": -2, "D4": -1,
      "E4": 0, "F4": 1, "G4": 2, "A4": 3, "B4": 4, "C5": 5
    };

    const STAFF_TOP_Y = 30;
    const STAFF_LINE_SPACING = 12;
    const STAFF_CENTER_Y = STAFF_TOP_Y + 2 * STAFF_LINE_SPACING;

    // ============== STATE ===============

    let currentLevelId = 1;
    let currentMode = "learn";
    let currentNote = "C4";
    let currentExerciseType = "flashcard";

    let streak = 0;
    let totalAttempts = 0;
    let totalCorrect = 0;
    let practiceSeconds = 0;

    let examMode = null;
    let examScore = 0;
    let examQuestions = 0;

    let audioCtx = null;
    let midiEnabled = false;

    // ============== DOM HELPERS ===============

    const qs = (sel) => document.querySelector(sel);
    const qsa = (sel) => Array.from(document.querySelectorAll(sel));

    // ============== STAFF RENDERING ===============

    function renderStaffLines() {
      const staffEl = qs("#staff");
      staffEl.innerHTML = "";

      // Draw 5 staff lines
      for (let i = 0; i < 5; i++) {
        const line = document.createElement("div");
        line.className = "staff-line";
        line.style.top = (STAFF_TOP_Y + i * STAFF_LINE_SPACING) + "px";
        staffEl.appendChild(line);
      }
    }

    function getNoteY(noteName) {
      const step = STEP_INDEX[noteName] ?? 0;
      const halfSpacing = STAFF_LINE_SPACING / 2;
      return STAFF_CENTER_Y - step * halfSpacing;
    }

    function positionStaffNote(noteName) {
      const staffEl = qs("#staff");
      const noteEl = qs("#staff-note");

      // Remove old note
      if (!noteEl) {
        const newNote = document.createElement("div");
        newNote.id = "staff-note";
        newNote.className = "staff-note";
        staffEl.appendChild(newNote);
      }

      const y = getNoteY(noteName);
      const note = qs("#staff-note");
      note.style.top = y + "px";
      note.style.left = "50%";
      note.style.transform = "translate(-50%, -50%) scale(1)";

      // Clear old ledger
      qsa(".ledger-line").forEach(el => el.remove());

      // Add ledger if needed
      if (STEP_INDEX[noteName] <= -2) {
        const ledger = document.createElement("div");
        ledger.className = "ledger-line";
        ledger.style.top = getNoteY("C4") + "px";
        staffEl.appendChild(ledger);
      }
    }

    // ============== AUDIO ===============

    function getFrequency(noteName) {
      const midi = NOTE_TO_MIDI[noteName] ?? 60;
      return 440 * Math.pow(2, (midi - 69) / 12);
    }

    function playNote(noteName, duration = 1.0) {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }

      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      osc.type = "sine";
      osc.frequency.value = getFrequency(noteName);
      osc.connect(gain);
      gain.connect(audioCtx.destination);

      const now = audioCtx.currentTime;
      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.exponentialRampToValueAtTime(0.2, now + 0.05);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + duration);

      osc.start(now);
      osc.stop(now + duration + 0.05);
    }

    // ============== LEVELS & UI ===============

    function initLevels() {
      const container = qs("#level-list");
      container.innerHTML = "";

      LEVELS.forEach(lvl => {
        const div = document.createElement("div");
        div.className = "level-item" + (lvl.id === 1 ? " active" : "");
        div.dataset.levelId = lvl.id;

        const tagPill = lvl.id <= 3 ? "teach" : lvl.id <= 5 ? "play" : lvl.id === 6 || lvl.id === 9 || lvl.id === 13 ? "ear" : "practice";
        const tagColor = tagPill === "teach" ? "blue" : "gray";

        div.innerHTML = `
          <div>
            <div class="level-title">L${lvl.id}: ${lvl.title}</div>
            <div class="level-tag">${lvl.tag} ‚Ä¢ ${lvl.hours}h</div>
          </div>
          <span class="pill ${lvl.id === 1 ? 'green' : tagColor}">${lvl.id === 1 ? 'Active' : lvl.tag.split(' ')[0]}</span>
        `;

        div.addEventListener("click", () => loadLevel(lvl.id));
        container.appendChild(div);
      });
    }

    function loadLevel(levelId) {
      currentLevelId = levelId;
      const lvl = LEVELS.find(l => l.id === levelId);

      // Update sidebar
      qsa(".level-item").forEach(item => item.classList.remove("active"));
      qs(`[data-levelid="${levelId}"]`).classList.add("active");

      // Update main panel
      qs("#panel-title").textContent = `Level ${lvl.id}: ${lvl.title}`;
      qs("#panel-subtitle").textContent = `${lvl.tag} ‚Ä¢ Focus: ${lvl.notes.join(", ")}`;

      // Teaching box
      qs("#teach-content").innerHTML = lvl.teach;

      // Set exercise type
      currentExerciseType = lvl.type;

      // Show/hide controls
      const audioCtrl = qs("#audio-controls");
      const flashcardRow = qs("#flashcard-row");

      if (currentExerciseType === "ear") {
        audioCtrl.style.display = "block";
        flashcardRow.style.display = "flex";
      } else if (currentExerciseType === "teach") {
        audioCtrl.style.display = "none";
        flashcardRow.style.display = "none";
        qs("#prompt-text").textContent = "Read the teaching section above. No interaction yet‚Äîjust learn! Click 'Start Practice' below when ready.";
      } else {
        audioCtrl.style.display = "none";
        flashcardRow.style.display = "flex";
      }

      // Update hours
      const practiced = Math.min(TOTAL_HOURS, Math.floor(totalAttempts / 30));
      qs("#total-hours").textContent = `${practiced}/${TOTAL_HOURS} hrs`;

      pickRandomNote();
    }

    function pickRandomNote() {
      const lvl = LEVELS.find(l => l.id === currentLevelId);
      if (!lvl) return;

      currentNote = lvl.notes[Math.floor(Math.random() * lvl.notes.length)];
      positionStaffNote(currentNote);

      if (currentExerciseType === "teach") {
        qs("#prompt-text").textContent = "Reading time! See the teaching section. No practice yet.";
      } else if (currentExerciseType === "ear") {
        qs("#prompt-text").textContent = "Click 'Play Note' to hear a note, then identify it on the staff or choose the letter.";
        renderFlashcard(currentNote);
      } else {
        qs("#prompt-text").textContent = `Play the note shown on the staff or choose its letter name.`;
        renderFlashcard(currentNote);
      }

      highlightVirtualKey(null);
    }

    function renderFlashcard(noteName) {
      const correctLetter = noteName.replace(/[0-9]/g, "");
      const letters = ["A", "B", "C", "D", "E", "F", "G"];
      const options = new Set([correctLetter]);

      while (options.size < 4) {
        options.add(letters[Math.floor(Math.random() * letters.length)]);
      }

      const shuffled = Array.from(options).sort(() => Math.random() - 0.5);
      const optionsEl = qs("#flashcard-options");
      optionsEl.innerHTML = "";

      shuffled.forEach(letter => {
        const btn = document.createElement("button");
        btn.className = "flashcard-btn";
        btn.textContent = letter;
        btn.addEventListener("click", () => handleFlashcardAnswer(letter === correctLetter));
        optionsEl.appendChild(btn);
      });
    }

    function handleNoteInput(noteName) {
      const isCorrect = noteName === currentNote;
      totalAttempts++;
      if (isCorrect) totalCorrect++;

      if (isCorrect) {
        streak++;
        highlightVirtualKey(noteName);
        qs("#staff-note").style.transform = "translate(-50%, -50%) scale(1.2)";
        setTimeout(() => {
          qs("#staff-note").style.transform = "translate(-50%, -50%) scale(1)";
        }, 150);

        if (examMode === "performance") {
          examQuestions++;
          examScore++;
        }

        setTimeout(pickRandomNote, 500);
      } else {
        streak = 0;
        if (examMode === "performance") {
          examQuestions++;
        }
      }

      updateStats();
    }

    function handleFlashcardAnswer(isCorrect) {
      totalAttempts++;
      if (isCorrect) {
        totalCorrect++;
        streak++;
      } else {
        streak = 0;
      }

      if (examMode === "theory") {
        examQuestions++;
        if (isCorrect) examScore++;
      }

      updateStats();

      // Show feedback
      qsa(".flashcard-btn").forEach(btn => {
        btn.classList.remove("correct", "wrong");
        if (btn.textContent === currentNote.replace(/[0-9]/g, "")) {
          btn.classList.add("correct");
        }
      });

      setTimeout(pickRandomNote, 400);
    }

    function highlightVirtualKey(noteName) {
      qsa(".white-key").forEach(key => {
        key.classList.toggle("active", !!noteName && key.dataset.note === noteName);
      });
    }

    // ============== KEYBOARD ===============

    function initKeyboard() {
      const container = qs("#white-keys");
      container.innerHTML = "";

      WHITE_NOTES.forEach(note => {
        const key = document.createElement("div");
        key.className = "white-key";
        key.dataset.note = note;
        key.innerHTML = `<span>${note.replace(/[0-9]/g, "")}</span>`;
        key.addEventListener("mousedown", () => handleNoteInput(note));
        key.addEventListener("touchstart", (e) => {
          e.preventDefault();
          handleNoteInput(note);
        });
        container.appendChild(key);
      });
    }

    // ============== TABS ===============

    function initTabs() {
      qsa(".tab").forEach(tab => {
        tab.addEventListener("click", () => {
          qsa(".tab").forEach(t => t.classList.remove("active"));
          tab.classList.add("active");

          const tabId = tab.dataset.tab;
          if (tabId === "learn") {
            currentMode = "learn";
            qs("#mode-label").textContent = "Learn";
          } else if (tabId === "practice") {
            currentMode = "practice";
            qs("#mode-label").textContent = "Practice";
          } else {
            currentMode = "exam";
            qs("#mode-label").textContent = "Exam";
          }
        });
      });
    }

    // ============== EXAM ===============

    function startExam(type) {
      examMode = type;
      examScore = 0;
      examQuestions = 0;
      streak = 0;
      totalAttempts = 0;
      totalCorrect = 0;

      qs(".tab[data-tab='exam']").click();
      qs("#mode-label").textContent = "Exam: " + type.toUpperCase();
      qs("#end-exam-btn").style.display = "inline-block";

      updateStats();
      pickRandomNote();
    }

    function endExam() {
      if (!examMode) return;

      const pct = examQuestions === 0 ? 0 : Math.round((examScore / examQuestions) * 100);
      let band = "Below Pass";
      if (pct >= 90) band = "Distinction";
      else if (pct >= 80) band = "Merit";
      else if (pct >= 60) band = "Pass";

      qs("#exam-summary").innerHTML = `
        <strong>Exam Complete!</strong><br>
        <span class="metric">Mode: <span class="metric-value">${examMode.toUpperCase()}</span></span>
        <span class="metric">Score: <span class="metric-value">${pct}%</span></span>
        <span class="metric">Questions: <span class="metric-value">${examScore}/${examQuestions}</span></span>
        <span class="metric">Level: <span class="metric-value">${band}</span></span>
      `;

      examMode = null;
      qs("#end-exam-btn").style.display = "none";
      qs("#mode-label").textContent = "Learn";
    }

    // ============== STATS ===============

    function updateStats() {
      qs("#streak").textContent = streak;

      const acc = totalAttempts === 0 ? 100 : Math.round((totalCorrect / totalAttempts) * 100);
      qs("#accuracy").textContent = acc + "%";

      const practiced = Math.min(TOTAL_HOURS, Math.floor(totalAttempts / 30));
      qs("#total-hours").textContent = `${practiced}/${TOTAL_HOURS} hrs`;

      if (examMode) {
        const pct = examQuestions === 0 ? 0 : Math.round((examScore / examQuestions) * 100);
        qs("#exam-summary").innerHTML = `
          <strong>Exam in progress...</strong><br>
          <span class="metric">Mode: <span class="metric-value">${examMode.toUpperCase()}</span></span>
          <span class="metric">Current: <span class="metric-value">${pct}%</span></span>
          <span class="metric">Questions: <span class="metric-value">${examScore}/${examQuestions}</span></span>
        `;
      }
    }

    // ============== INIT ===============

    window.addEventListener("DOMContentLoaded", () => {
      renderStaffLines();
      initLevels();
      initKeyboard();
      initTabs();

      loadLevel(1);

      // Event listeners
      qs("#play-note-btn").addEventListener("click", () => {
        playNote(currentNote);
      });

      qs("#start-practice-btn").addEventListener("click", () => {
        qs(".tab[data-tab='practice']").click();
      });

      qs("#start-theory-exam").addEventListener("click", () => {
        if (totalAttempts >= 20) {
          startExam("theory");
        } else {
          alert("Practice at least 20 questions first! You have " + totalAttempts);
        }
      });

      qs("#start-performance-exam").addEventListener("click", () => {
        if (totalAttempts >= 20) {
          startExam("performance");
        } else {
          alert("Practice at least 20 questions first! You have " + totalAttempts);
        }
      });

      qs("#end-exam-btn").addEventListener("click", endExam);

      // MIDI init (optional)
      if (navigator.requestMIDIAccess) {
        navigator.requestMIDIAccess().then(access => {
          for (const input of access.inputs.values()) {
            input.onmidimessage = msg => {
              const [status, data1] = msg.data;
              if ((status & 0xf0) === 0x90 && msg.data[2] > 0) {
                for (const [note, midi] of Object.entries(NOTE_TO_MIDI)) {
                  if (midi === data1) handleNoteInput(note);
                }
              }
            };
          }
          midiEnabled = true;
        });
      }
    });
  </script>
</body>
</html>